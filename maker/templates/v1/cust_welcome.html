{% extends 'v1/base.html' %}

{% load staticfiles %}
{% load autoVersion %}
{% block title %}电子贺卡定制{% endblock %}
{% block welcome_active %}active{% endblock %}
{% block icon-welcome-index %}<span class="si si-index si-1-h"></span>{% endblock %}
{% block icon-welcome %}<span class="si si-menu si-ecard-h"></span>{% endblock %}
{% block icon-welcome-active %}<span class="si si-mactive"></span>{% endblock %}

{% block your_css %}
<link href="{% auto_version '/static/css/jquery-ui.min.css" rel="stylesheet" type="text/css' %}" >
<style>
    .boxWel {
        width:177px;
        position: relative;
        display:block;
    }
    .textPre {
        width: 50%;
        text-align: center;
        position: absolute;
        left: -6%;
        top: -12%;
        /*transform: translateY(-50%);*/
        transform: scale(0.8);
        font-weight: bold;
        font-size: 18px;
    }
    .modal-dialog-center {
        margin-top: 15%;
    }
    .co{
        color:darkgray;
    }
    .carousel-indicators li {
        background-color: #bbbbaa;
        border: 1px solid #bbbbaa;
        width:5;
        height:5;
    }
    .carousel-indicators .active {
        background-color: #ff4b00;
        border: 1px solid #ff4b00;
        width:5;
        height:5;
    }
</style>
{% endblock %}

{% block modal_block %}
{% endblock %}

{% block menu_right_block %}
<div class="col-xl-9 col-lg-9 col-md-9 col-sm-12" id="menu_right">
    <div class="text-left col-md-12 wrapper">
        <ul class="tip col-md-12 text-mute">
        </ul>
    </div>
    <div class="panel panel-cd">
        <div class="row row-cd">
            <div class="col-xl-4 col-lg-3 col-md-4 col-sm-4">
                <div class="preview-panel-{{mclass}} align-center" data-step="4" data-intro='步骤4: 查看预览的效果， 如果不满意可进行修改'>
                    <img src="/static/images/{{mclass}}_wp_bg.png">
                    <p id="preview"></p>
                </div>
                <div class="align-center">
                    <a class='btn btn-cd-g align-center' href='/v1/maker/cust/animation/' >下一项定制</a>
                </div>
            </div>
            <!-- /.col-lg-3 -->
            <div class="col-xl-8 col-lg-9 col-md-8 col-sm-8 panel-cd-main">
                <div id="textdiv" style="top:10px;height:170px; background-size:100% 100%; background-image: url(/static/images/welcomebackground2.png?imageView2/3/w/320/h/170); background-repeat: no-repeat" src="/static/images/welcomebackground2.png?imageView2/3/w/320/h/170" class="img-background wp-pl wp-pr" data-step="2" data-intro='步骤2: 填入您想和对方说的话，以及您的落款'>
                    <div>
                        <input id="textForTo" placeholder="亲爱的妈妈：" style="background:transparent;border-style:none; border: 0; position:relative;left:25px;top:13px; width:80px" maxlength="5">
                    </div>
                    <div>
                        <textarea id="contentediTable" placeholder="是您让我有了精彩的人生，感谢您！" maxlength="50" rows="3" draggable="false" style="resize:none; background:transparent;border-style:none; word-wrap:break-word; position:relative; left:25px; top:15px; height:85px; width:300px;line-height:200%; border:0px" onkeyup="checkLength(this)" ></textarea>
                    </div>
                    <div>
                        <input id="textForMe" placeholder="爱您的儿子" style="background:transparent;border-style:none; border: 0; position:relative; float:right; right: 15%; top:15px ; width:75px" maxlength="5" alt="称呼：">
                    </div>
                </div>
                <div class="wp-pl" style="float:left;padding-top:15px">
                    <span id="chLeft">卡片正文输入在30个字以内</span>
                </div>
                <div  class="wp-pr" style="float:right;padding-top:15px">
                    <button onclick="actionForReset()" type="button" class="btn btn-cd-g">重置</button>
                    <button onclick="savetext()" type="button" class="btn btn-primary" data-step="3" data-intro='步骤3: 点击预览'>预览</button>
                </div>
                <div class="clearfix"></div>
                <div data-step="1" data-position='left' data-intro='步骤1: 挑选电子贺卡的样式'>
                    <span class="nav-tabs-cd-title wp-pl">选择卡片样式</span>
                    <div style="padding-top:10px">
                        {% if prebuilts %}
                        <table class="wp-table-pr">
                            <tr>
                                <td>
                                    {% ifnotequal curPage 1 %}
                                    <a href="?curCate={{ curCate }}&&curPage={{ curPage }}&&allPage={{ allPage }}&&pageType=up"><i class='si si-pl-a'></i></a>
                                    {% else %}
                                    <i class='si si-pl'></i>
                                    {% endifnotequal %}
                                </td>
                                <td class="prebuilt-img-list">
                                    <ul class="gallery ui-helper-reset">
                                        {% for index,prebuilt in prebuilts %}
                                        <li>
                                            <div class="prebuilt-img" id="pb-img-{{index}}" style="background-image:url({{prebuilt.res_file_path}}?imageView2/3/w/120/h/200);" onclick="selectImage('{{prebuilt.res_file_path}}','','1','','{{index}}', 'img-hl-{{index}}')">
                                                <div class="prebuilt-img-highlight" id="img-hl-{{index}}"></div>
                                                <img class="prebuilt-img-check" id="img-{{index}}" data-path="{{prebuilt.res_file_path}}" src="{% auto_version '/static/images/none.png' %}">
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </td>
                                <td>
                                    {% ifnotequal curPage allPage %}
                                    <a href="?curCate={{ curCate }}&&curPage={{ curPage }}&&allPage={{ allPage }}&&pageType=down"><i class='si si-pr-a'></i></a>
                                    {% else %}
                                    <i class='si si-pr'></i>
                                    {% endifnotequal %}
                                </td>
                            </tr>
                        </table>
                        {% else %}
                        <strong>No prebuilt currently.</strong>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- /.col-lg-9 -->
        </div>
        <!-- /.row -->
    </div>
    <!-- /.panel -->
</div>
<div class="modal fade" id="splashModal" tabindex="-1" data-backdrop="static" data-keyboard="false" style="background: rgba(0,0,0,.5);">
    <div class="modal-dialog modal-dialog-center" role="document" style="margin-top:5%;width:1000px;">
        <div class="modal-content" style="background:transparent;border:0;box-shadow:0 0 0;border-radius:0;">
            <div class="modal-body" style="height:500px;">
                <button type="button" class="close" data-dismiss="modal" data-toggle="modal" aria-label="Close" style="color:#fff;font-size:14px;font-weight:normal;text-shadow:0 0 0;padding-right:5%;padding-bottom:3px;opacity: .5;" onClick="setCookie('splash', '0', 10);">跳过</button>
                <div class="clearfix"></div>
                <div id="splash_prev" style="width:5%;height:460px;text-align:center;transform: translateY(45%);float:left;"><i class='si si-spl'></i></div>
                <div style="width:90%;height:460px;float:left;">
                    <div style="width:60%;height:100%;float:left;background-color:#fff;border-radius: 5px 0 0 5px;text-align:center;">
                        <div id="splash_title" style="padding-top:80px;font-size:22px;">第一层好礼</div>
                        <div style="padding-top:60px;"><img src="/static/images/splash0.png"/></div>
                        <div id="splash_content" style="padding-top:65px;font-size:22px;">礼物贺卡，满满的祝福，洋溢纸上</div>
                    </div>
                    <div style="position: relative;width:40%;height:100%;float:right;background-color:#dcdcdc;border-radius: 0 5px 5px 0;padding-top:20px;">
                        <img style="position: absolute;top:40px;left:100px;" src="/static/images/splash_bg.png">
                        <img id="splash_image" style="position: absolute;top:79px;left:111px;" src="/static/images/splash1.png">
                    </div>
                </div>
                <div id="splash_next" style="width:5%;height:460px;text-align:center;transform: translateY(45%);float:left;"><a onclick="showSplash(2)" href="javascript:void(0);"><i class='si si-spr-a'></i></a></div>
                <div class="clearfix"></div>
                <div style="text-align:center;padding-top:10px">
                    <ol class="carousel-indicators" style="position:relative;bottom:0;">
                        <li id="splash_1" onclick="showSplash(1)" class="active"></li>
                        <li id="splash_2" onclick="showSplash(2)"></li>
                        <li id="splash_3" onclick="showSplash(3)"></li>
                        <li id="splash_4" onclick="showSplash(4)"></li>
                        <li id="splash_5" onclick="showSplash(5)"></li>
                        <li id="splash_6" onclick="showSplash(6)"></li>
                        <li id="splash_7" onclick="showSplash(7)"></li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block your_js %}
<script type="text/javascript">
    window.onkeydown = function(){
        var len = $('#contentediTable').val().length;
        if(len > 50) {

        }
    }

    function alert2(title, body) {
        showToast('error', body)
    }

    function savetext() {
        var textforcontent =$('#contentediTable').val();
        var textforto = $('#textForTo').val();
        var textforme = $('#textForMe').val();

        if(textforto =='')
        {
            alert2('提示','请输入称呼');
            return;
        }
        if(textforcontent =='')
        {
            alert2('提示','请输入您想说的话');
            return;
        }
        if(textforme =='')
        {
            alert2('提示','请输入署名');
            return;
        }

        var tmp = Cookies.getJSON('welcome-choose');

        if(!tmp || tmp.welcomefilename =='')
        {
            alert2('提示','请选择模版');
            return;
        }

        _hmt.push(['_trackEvent', 'welcome_save', 'Save', '保存贺卡']);

        /* Note - all body text wrap logic would be handled at Server side */

        Cookies.set('textEdit', {"textForTo":textforto,"contentediTable":textforcontent,"textForMe":textforme});


        var strForlog = JSON.stringify( { "makerID" : getCookie('makerid'), "template" : tmp.template, "title" :textforto, "body" :textforcontent, "signature" :textforme} );
        cdLog(strForlog);
        processForm(strForlog);
    }

    function processForm(strForJson){
        $.ajax({
            url: '/v1/maker/welcome/',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data:  strForJson,
            success: function(data) {
                var result = JSON.parse(JSON.stringify(data));
                if (result.code == "0") {
                    var urlfork = result.url;
                    var filename_preview = urlfork+"/?imageView2/3/w/169/h/283";
                    if (getCookie("welcome-changefilename") == "") {
                        increaseCustomItemCount();
                    }
                    setCookie("welcome-changefilename", urlfork);
                    document.getElementById("preview").innerHTML="<img class='preview-wp-"+mclass+"' src='"+urlfork+"'>";
                }

            },
            error: function( jqXhr, textStatus, errorThrown ){
                cdLog( errorThrown );
            }
        });
    }

    function actionForReset(){
        if (getCookie("welcome-changefilename") != "") {
            decreaseCustomItemCount();
        }
        Cookies.remove('textEdit');
        Cookies.remove('welcome-choose');
        setCookie("welcome-changefilename", '');

        for (var i = 0; i < 4; i++) {
            var tmp_img = document.getElementById("img-"+i);
            if (tmp_img) {
                tmp_img.src = "/static/images/none.png";
            } else {
                break;
            }
        }
        document.getElementById("preview").innerHTML="<div></div>"
    }

    function edit(html)
    {
        if(event.keyCode==13){
            var   textRange=document.selection.createRange();
            textRange.text="\r\n";
            textRange.select();
            event.returnValue=false;
        }
    }

    function selectImage(filename, md5, prebuilt, crop, witchcard, hl_id) {
        var tmp = Cookies.getJSON('welcome-choose');
        if (tmp && tmp.welcomefilename==filename) {
            document.getElementById("img-"+witchcard).src="{% auto_version '/static/images/none.png' %}";
            $("#"+hl_id).css('visibility','hidden');
            Cookies.remove('welcome-choose');
            return;
        }
        for (var i = 0; i < 4; i++) {
            var tmp_img = document.getElementById("img-"+i);
            if (tmp_img) {
                if (i != witchcard) {
                    tmp_img.src = "/static/images/none.png";
                    $("#img-hl-"+i).css('visibility','hidden');
                } else {
                    tmp_img.src = "/static/images/checkbox.png";
                    $("#img-hl-"+i).css('visibility','visible');
                }
            } else {
                break;
            }
        }
        var templateNumber = parseInt(witchcard)+1;
        Cookies.set('welcome-choose', {"template":templateNumber,"welcomefilename":filename});
    }


    window.onload = function() {
        var tmp = Cookies.getJSON('welcome-choose');
        if(tmp)
        {
            var filename = '';
            filename = tmp.welcomefilename;
            if (filename != "") {
                for (var j = 0; j < 4; j++) {
                    var tmp_img =document.getElementById("img-"+j);
                    if (tmp_img) {
                        if (filename == tmp_img.getAttribute("data-path")) {
                            tmp_img.src = "/static/images/checkbox.png";
                            $("#img-hl-"+j).css('visibility','visible');
                            break;
                        }
                    } else {
                        break;
                    }
                }
            }
        }
        var tmp2 = Cookies.getJSON('textEdit');
        if(tmp2)
        {
            document.getElementById("textForTo").value=tmp2.textForTo;
            document.getElementById("contentediTable").value=tmp2.contentediTable;
            document.getElementById("textForMe").value=tmp2.textForMe;

        }

        var changefilename = '';
        changefilename = getCookie("welcome-changefilename");
        if(changefilename != "")
        {
            var changefilename_preview = '';
            changefilename_preview = changefilename+"/?imageView2/3/w/169/h/283";
            document.getElementById("preview").innerHTML="<img class='preview-wp-"+mclass+"' src='"+changefilename+"'>";
        }
        loadCustomItemCount();
        var isSplashEnabled = '';
        isSplashEnabled = getCookie("splash");
        if (isSplashEnabled == '1')
        {
            $('#splashModal').modal('show');
        }
    }
    function showSplash(id) {
        var title="";
        var content="";
        var left="111px";
        switch(id) {
        case 1:
            title = "第一层好礼";
            content = "礼物贺卡，满满的祝福，洋溢纸上";
            break;
        case 2:
            title = "第二层好礼";
            content = "开机动画，全程DIY，满满的能量";
            left="42px";
            break;
        case 3:
            title = "第三层好礼";
            content = "全家福的锁屏壁纸，享受天伦之乐";
            break;
        case 4:
            title = "第四层好礼";
            content = "孙女的桌面壁纸，永远萌萌哒";
            break;
        case 5:
            title = "第五层好礼";
            content = "私人定制，来电铃声，永不担心漏接电话";
            break;
        case 6:
            title = "第六层好礼";
            content = "开机铃声，轻轻唤醒沉睡的耳朵";
            break;
        case 7:
            title = "第七层好礼";
            content = "预装App，一劳永逸";
            left="82px";
            break;
        }
        if (title != "") {
            $('.carousel-indicators').children().removeClass("active");
            $('#splash_'+id).addClass("active");
            $('#splash_image').attr("src", "/static/images/splash"+id+".png");
            $('#splash_image').css("left", left);
            document.getElementById("splash_title").innerHTML=title;
            document.getElementById("splash_content").innerHTML=content;
        }
        if (id < 7) {
            document.getElementById("splash_next").innerHTML='<a onclick="showSplash('+(id+1)+')" href="javascript:void(0);"><i class="si si-spr-a"></i></a>';
        } else {
            document.getElementById("splash_next").innerHTML='<i class="si si-spr"></i>';
        }
        if (id > 1) {
            document.getElementById("splash_prev").innerHTML='<a onclick="showSplash('+(id-1)+')" href="javascript:void(0);"><i class="si si-spl-a"></i></a>';
        } else {
            document.getElementById("splash_prev").innerHTML='<i class="si si-spl"></i>';
        }
    }

    function checkLength(which) { 
        var maxChars = 30; 
        if (which.value.length > maxChars) 
            which.value = which.value.substring(0,maxChars); 
            var curr = maxChars - which.value.length; 
            if (curr == maxChars) {
                document.getElementById("chLeft").innerHTML = "卡片正文输入在30个字以内";
            } else {
                document.getElementById("chLeft").innerHTML = "("+curr.toString()+"/30)";
            }
    }

    $(function() {
        $('#maker_help').on('click', function() {
            introJs().start();
        });
    });
</script>
{% endblock %}

